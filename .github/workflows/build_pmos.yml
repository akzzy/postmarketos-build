name: Build PostmarketOS for Poco F1

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Poco F1 (Tianma) Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install pmbootstrap
        run: |
          sudo apt-get update
          sudo apt-get install -y openssl git
          pip install git+https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git@master

      - name: Initialize pmbootstrap (Simplified)
        run: |
          # We send MINIMAL answers. 
          # We say 'none' for extra packages (we add them later).
          # We say 'n' for Timezone (use default GMT).
          # We hit Enter for Locale (use default).
          
          # Sequence:
          # 1. Work Path (Enter)
          # 2. Pmaports (Enter)
          # 3. Channel (edge)
          # 4. Vendor (xiaomi)
          # 5. Device (beryllium)
          # 6. Kernel (tianma)
          # 7. User (user)
          # 8. Provider (Enter/Default)
          # 9. UI (phosh)
          # 10. Systemd (Enter/Default)
          # 11. Change Opts? (n)
          # 12. Extra Pkgs (none)
          # 13. Timezone? (n)
          # 14. Locale (Enter/Default)
          # 15. Hostname (poco)
          # 16. Build outdated? (y)
          
          printf "\n\nedge\nxiaomi\nberyllium\ntianma\nuser\n\nphosh\n\nn\nnone\nn\n\npoco\ny\n" | pmbootstrap init

      - name: Build RootFS (The Real Fix)
        run: |
          pmbootstrap pull
          
          # THIS IS WHERE WE FIX THE WIFI.
          # We force 'iw' and 'wireless-regdb' to be added here, bypassing the init confusion.
          pmbootstrap install \
            --filesystem f2fs \
            --add "iw,wireless-regdb,nano,macchanger,modemmanager,device-xiaomi-beryllium-kernel-tianma" \
            --password "147147"

      - name: Export Images
        run: |
          pmbootstrap export
          cd /tmp/postmarketOS-export
          
          # Rename and Zip
          mv boot.img boot-tianma.img
          mv xiaomi-beryllium.img userdata-phosh.img
          zip -r poco-f1-images.zip boot-tianma.img userdata-phosh.img

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: poco-f1-images
          path: /tmp/postmarketOS-export/poco-f1-images.zip
