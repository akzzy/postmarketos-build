name: Build PostmarketOS for Poco F1

on:
  workflow_dispatch: # Allows you to manually trigger the build

jobs:
  build:
    name: Build Poco F1 (Tianma) Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install pmbootstrap
        run: |
          sudo apt-get update
          sudo apt-get install -y openssl git
          # Install directly from GitLab
          pip install git+https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git@master
          
      - name: Initialize pmbootstrap (Workaround)
        run: |
          # 1. Run init non-interactively to generate a default config
          # "yes ''" simulates pressing Enter for every question
          yes "" | pmbootstrap init

          # 2. Manually overwrite the config with Poco F1 settings
          pmbootstrap config channel edge
          pmbootstrap config vendor xiaomi
          pmbootstrap config device beryllium
          pmbootstrap config ui phosh
          pmbootstrap config hostname poco
          pmbootstrap config timezone "Asia/Kolkata"
          
          # 3. Download the specific packages for this device
          pmbootstrap pull

      - name: Build RootFS (Tianma Kernel & Regulatory Tools)
        run: |
          # --add includes the Regulatory tools (iw, wireless-regdb) AND the Tianma kernel
          pmbootstrap install \
            --filesystem f2fs \
            --add "iw,wireless-regdb,nano,macchanger,modemmanager,device-xiaomi-beryllium-kernel-tianma" \
            --password "147147"

      - name: Export Images
        run: |
          pmbootstrap export
          # Navigate to export folder and rename files for clarity
          cd /tmp/postmarketOS-export
          mv boot.img boot-tianma.img
          mv xiaomi-beryllium.img userdata-phosh.img

      - name: Create Flashable Zip
        run: |
          cd /tmp/postmarketOS-export
          zip -r poco-f1-pmos-tianma.zip boot-tianma.img userdata-phosh.img

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: poco-f1-images
          path: /tmp/postmarketOS-export/poco-f1-pmos-tianma.zip
          compression-level: 0
