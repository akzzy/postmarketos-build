name: Build PostmarketOS for Poco F1

on:
  workflow_dispatch: # Allows you to manually trigger the build

jobs:
  build:
    name: Build Poco F1 (Tianma) Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install pmbootstrap
        run: |
          sudo apt-get update
          sudo apt-get install -y openssl git
          # Install master branch to get latest device support
          pip install git+https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git@master

      - name: Configure pmbootstrap
        run: |
          # 1. Run a dummy init to download pmaports and setup default paths
          # We pipe 'yes' to accept all defaults (QEMU device, edge channel)
          yes "" | pmbootstrap init

          # 2. Switch the device to Poco F1 (Beryllium)
          # Setting 'device' automatically sets the vendor to 'xiaomi'
          pmbootstrap config device beryllium

          # 3. Configure User Interface and Hostname
          pmbootstrap config ui phosh
          pmbootstrap config hostname poco
          pmbootstrap config timezone "Asia/Kolkata"
          
          # 4. Force download of Poco F1 specific packages
          pmbootstrap pull

      - name: Build RootFS (Tianma Kernel + Reg Tools)
        run: |
          # We force the 'tianma' kernel package to prevent the screen issue.
          # We include 'iw' and 'wireless-regdb' to fix the 5GHz region crash.
          pmbootstrap install \
            --filesystem f2fs \
            --add "iw,wireless-regdb,nano,macchanger,modemmanager,device-xiaomi-beryllium-kernel-tianma" \
            --password "147147"

      - name: Export Images
        run: |
          pmbootstrap export
          # Rename files so you know which one is which
          cd /tmp/postmarketOS-export
          mv boot.img boot-tianma.img
          mv xiaomi-beryllium.img userdata-phosh.img

      - name: Create Flashable Zip
        run: |
          cd /tmp/postmarketOS-export
          zip -r poco-f1-pmos-tianma.zip boot-tianma.img userdata-phosh.img

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: poco-f1-images
          path: /tmp/postmarketOS-export/poco-f1-pmos-tianma.zip
          compression-level: 0
